module solve_ida

   implicit none

   integer :: neq = 6
   integer :: iout(50)
   real*8 :: rout(50)
   real*8 :: y0(6), yp0(6)
   real*8 :: diff(6), mas(6, 6)
   real*8 :: jac(6, 6)
   real*8 :: rates(11)
   real*8 :: dypdr(6, 11)
   integer :: dvacdy(1, 6)

end module solve_ida

subroutine initialize(neqin, y0in, rtol, atol, ipar, rpar, id_vec)

   use solve_ida, only: neq, iout, rout, y0, yp0, mas, diff, dypdr, dvacdy

   implicit none

   integer, intent(in) :: neqin, ipar(*)
   real*8, intent(in) :: y0in(neqin), rtol, atol(*)
   real*8, intent(in) :: rpar(*)
   real*8, intent(in) :: id_vec(neqin)
   real*8 :: constr_vec(neqin)
   real*8 :: t0, yptmp(neqin)
   integer :: nthreads, iatol, ier
   integer :: i
   integer :: meth, itmeth
   integer :: myid

   dypdr = 0
   dypdr(1, 1) = 1.00000000000000d0
   dypdr(1, 7) = -1.00000000000000d0
   dypdr(1, 8) = 1.00000000000000d0
   dypdr(2, 2) = 1.00000000000000d0
   dypdr(2, 4) = -1.00000000000000d0
   dypdr(2, 6) = 1.00000000000000d0
   dypdr(2, 11) = 1.00000000000000d0
   dypdr(3, 3) = 2.00000000000000d0
   dypdr(3, 4) = 1.00000000000000d0
   dypdr(3, 5) = 1.00000000000000d0
   dypdr(3, 9) = 1.00000000000000d0
   dypdr(4, 4) = 1.00000000000000d0
   dypdr(4, 5) = -1.00000000000000d0
   dypdr(4, 6) = -2.00000000000000d0
   dypdr(4, 8) = 1.00000000000000d0
   dypdr(4, 10) = 1.00000000000000d0
   dypdr(4, 11) = -1.00000000000000d0
   dypdr(5, 5) = 1.00000000000000d0
   dypdr(5, 6) = 1.00000000000000d0
   dypdr(5, 7) = -1.00000000000000d0
   dypdr(5, 10) = -1.00000000000000d0
   dypdr(6, 8) = -1.00000000000000d0
   dypdr(6, 9) = -1.00000000000000d0
   dypdr(6, 10) = -1.00000000000000d0
   dypdr(6, 11) = -1.00000000000000d0

   dvacdy = 0
   dvacdy(1, 1) = -1
   dvacdy(1, 2) = -1
   dvacdy(1, 3) = -1
   dvacdy(1, 4) = -1
   dvacdy(1, 5) = -1
   dvacdy(1, 6) = -1

   iatol = 2
   constr_vec = 1.d0

   y0 = y0in
   yp0 = 0
   yptmp = 0
   diff = id_vec
   mas = 0
   t0 = 0
   meth = 2  ! 1 = Adams (nonstiff), 2 = BDF (stiff)
   itmeth = 2  ! 1 = functional iteration, 2 = Newton iteration

   do i = 1, neq
      mas(i, i) = id_vec(i)
   enddo

!   ! Calculate yp
   call fidaresfun(0.d0, y0, yptmp, yp0, ipar, rpar, ier)

   ! initialize Sundials
   call fnvinits(2, neq, ier)
   ! allocate memory
   call fidamalloc(t0, y0, yp0, iatol, rtol, atol, iout, rout, ipar, rpar, ier)
   ! set maximum number of steps (default = 500)
   call fidasetiin('MAX_NSTEPS', 50000, ier)
   ! set algebraic variables
   call fidasetvin('ID_VEC', id_vec, ier)
   ! set constraints (all yi >= 0.)
   call fidasetvin('CONSTR_VEC', constr_vec, ier)

!Uncomment the following lines for Sundials 2.X
!   call fidalapackdense(neq, ier)
!   call fidalapackdensesetjac(1, ier)

!Uncomment these lines for Sundials 4.X (and comment about the above)
  call FSUNDenseMatInit(2, neq, neq, ier)
  call FSUNLAPACKDENSEINIT(2, ier)
  call FIDALSINIT(ier)

end subroutine initialize

subroutine find_steady_state(neqin, nrates, dt, maxiter, epsilon, t1, u1, du1, r1)

   use solve_ida, only: y0, yp0, iout, rout, rates, dypdr

   implicit none

   integer, intent(in) :: neqin, nrates, maxiter
   real*8, intent(in) :: dt, epsilon

   real*8 :: rpar(1)
   integer :: ipar(1)

   real*8, intent(out) :: t1, u1(neqin), du1(neqin), r1(nrates)

   real*8 :: tout, epsilon2
   real*8 :: dutmp(neqin), du0(neqin)
   integer :: itask, ier
   integer :: i

   logical :: converged = .FALSE.

   epsilon2 = epsilon**2
   i = 0
   itask = 1
   tout = 0.0d0
   u1 = y0
   du1 = yp0
   t1 = 0.d0
   du0 = 0.d0

   call fidacalcic(1, dt, ier)

   do while (.not. converged)
      if (tout - t1 < dt * 0.01) then
         tout = tout + dt
      end if

      call fidasolve(tout, t1, u1, du1, itask, ier)

      i = i + 1

      call fidaresfun(tout, u1, du0, dutmp, ipar, rpar, ier)

      if (maxval(dutmp**2) < epsilon2) then
         converged = .TRUE.
      end if
      if (i >= maxiter) then
         print *, "ODE NOT CONVERGED!"
         exit
      end if
   end do
   
   call ratecalc(6, u1)
   r1 = rates

end subroutine find_steady_state

subroutine solve(neqin, nrates, nt, tfinal, t1, u1, du1, r1)

   use solve_ida, only: y0, yp0, iout, rout, rates

   implicit none

   integer, intent(in) :: neqin, nt, nrates
   real*8, intent(in) :: tfinal

   real*8 :: rpar(1)
   integer :: ipar(1)

   real*8, intent(out) :: t1(nt)
   real*8, intent(out) :: u1(neqin, nt), du1(neqin, nt)
   real*8, intent(out) :: r1(nrates, nt)

   real*8 :: dt, tout
   integer :: itask, ier
   integer :: i

   itask = 1
   dt = tfinal / (nt - 1)
   tout = 0.0d0
   u1 = 0
   du1 = 0
   u1(:, 1) = y0
   du1(:, 1) = yp0
   t1(1) = 0.d0
   call ratecalc(6, u1(:, 1))
   r1(:, 1) = rates


!   call fidacalcic(1, dt, ier)

   do i = 2, nt
      tout = tout + dt
      do while (tout - t1(i) > dt * 0.01)
         call fidasolve(tout, t1(i), u1(:, i), du1(:, i), itask, ier)
      end do
      r1(:, i) = rates
   end do

end subroutine solve

subroutine finalize

   implicit none

   call fidafree

end subroutine finalize

subroutine fidaresfun(tres, yin, ypin, res, ipar, rpar, reserr)

   use solve_ida, only: neq, diff, dypdr, rates

   implicit none

   integer, intent(in) :: ipar(*)
   integer, intent(out) :: reserr
   real*8, intent(in) :: tres, rpar(*)
   real*8, intent(in) :: yin(neq), ypin(neq)
   real*8, intent(out) :: res(neq)
   real*8 :: y(neq)

   integer :: i

   reserr = 0

   y = yin
   res = 0


   do i = 1, neq
      if (y(i) < -1d-10)  then
!         y(i) = 0.d0
         reserr = 1
      endif
   enddo

   call ratecalc(6, y)

   res = matmul(dypdr, rates) - diff * ypin
   
end subroutine fidaresfun

subroutine fidadjac(neqin, t, yin, ypin, r, jac, cj, ewt, h, ipar, rpar, wk1, wk2, wk3, djacerr)

   use solve_ida, only: mas, dypdr, dvacdy
    
   implicit none
   
   integer :: neqin, ipar(*)
   integer :: djacerr
   real*8 :: t, h, cj, rpar(*)
   real*8 :: yin(neqin), ypin(neqin), r(neqin), ewt(*), jac(neqin, neqin)
   real*8 :: wk1(*), wk2(*), wk3(*)
   real*8 :: y(neqin), drdy(11, 6), drdvac(11, 1), vac(1)

   integer :: i

   djacerr = 0

   jac = 0
   y = yin

   do i = 1, neqin
      if (y(i) < -1d-10) then
         y(i) = 0.d0
         djacerr = 1
      endif
   enddo

   vac = 0
   vac(1) = -y(1) - y(6) - y(3) - y(2) - y(5) - y(4) + 1

   do i = 1, 1
      if (vac(i) < -1d-10) then
         vac(i) = 0.d0
         djacerr = 1
      endif
   enddo

   drdy = 0
   drdy(1, 1) = -80.3130258619031d0*y(1)*exp(34.810185027303113d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4)) - 2.30717032382649d0*exp( &
      34.810185027303113d0*y(1) + 42.200083419298494d0*y(6) + &
      5.2748030187688606d0*y(3) + 2.3421784076945262d0*y(2) + &
      25.451828643253517d0*y(5) + 5.839099818459224d0*y(4))
   drdy(1, 2) = -5.40380451534d0*y(1)*exp(34.810185027303113d0*y(1) + 42.200083419298494d0* &
      y(6) + 5.2748030187688606d0*y(3) + 2.3421784076945262d0*y(2) + &
      25.451828643253517d0*y(5) + 5.839099818459224d0*y(4))
   drdy(1, 3) = -12.1698689889339d0*y(1)*exp(34.810185027303113d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))
   drdy(1, 4) = -13.4717978190098d0*y(1)*exp(34.810185027303113d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))
   drdy(1, 5) = -58.7217037328316d0*y(1)*exp(34.810185027303113d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))
   drdy(1, 6) = -97.3627801280079d0*y(1)*exp(34.810185027303113d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))
   drdy(2, 1) = -594020672738.503d0*y(2)*exp(2.3421784076945262d0*y(1))
   drdy(2, 2) = -253618883509.056d0*exp(2.3421784076945262d0*y(1))
   drdy(3, 1) = -1615951278.83558d0*y(3)**2*exp(10.549606037537721d0*y(1))
   drdy(3, 3) = -306352914.617983d0*y(3)*exp(10.549606037537721d0*y(1))
   drdy(4, 1) = -131016040476.553d0*y(3)*y(4)*exp(1.9762044110737795d0*y(1)) - &
      1778345.85971439d0*y(2)*vac(1)*exp(-6.7955200184597802d0*y(1))
   drdy(4, 2) = 261693.859319608d0*vac(1)*exp(-6.7955200184597802d0*y(1))
   drdy(4, 3) = -66296806009.741d0*y(4)*exp(1.9762044110737795d0*y(1))
   drdy(4, 4) = -66296806009.741d0*y(3)*exp(1.9762044110737795d0*y(1))
   drdy(5, 1) = -12706295.4583176d0*y(3)*y(5)*exp(-15.408208399833654d0*y(1) - &
      30.747507666161923d0*y(5))*exp(24.887531843563153d0*y(1) + &
      49.663760788701971d0*y(5)) - 984.122185978592d0*y(4)*vac(1)*exp( &
      -15.408208399833654d0*y(1) - 30.747507666161923d0*y(5))
   drdy(5, 3) = -1340422.18664063d0*y(5)*exp(-15.408208399833654d0*y(1) - &
      30.747507666161923d0*y(5))*exp(24.887531843563153d0*y(1) + &
      49.663760788701971d0*y(5))
   drdy(5, 4) = 63.869994514691d0*vac(1)*exp(-15.408208399833654d0*y(1) - &
      30.747507666161923d0*y(5))
   drdy(5, 5) = -25355765.3735627d0*y(3)*y(5)*exp(-15.408208399833654d0*y(1) - &
      30.747507666161923d0*y(5))*exp(24.887531843563153d0*y(1) + &
      49.663760788701971d0*y(5)) - 1340422.18664063d0*y(3)*exp( &
      -15.408208399833654d0*y(1) - 30.747507666161923d0*y(5))*exp( &
      24.887531843563153d0*y(1) + 49.663760788701971d0*y(5)) - &
      1963.84314597818d0*y(4)*vac(1)*exp(-15.408208399833654d0*y(1) - &
      30.747507666161923d0*y(5))
   drdy(6, 1) = -14548778171483.8d0*y(2)*y(5)*exp(-32.231614828059186d0*y(1) - &
      99.327521577403942d0*y(5))*exp(16.115807414029593d0*y(1) + &
      49.663760788701971d0*y(5))/(exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5)) + 0.0828410614545045d0)**2 - &
      2.3102767664709d+28*y(4)**2*exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5))/(131547664918868.0d0*exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5)) + &
      10897548193740.5d0) + 175622787975428.0d0*y(4)**2*exp( &
      -32.231614828059186d0*y(1) - 99.327521577403942d0*y(5))/(exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5)) + &
      0.0828410614545045d0)**2
   drdy(6, 2) = -1.18756556634897d+26*y(5)*exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5))*exp(16.115807414029593d0*y(1) + &
      49.663760788701971d0*y(5))/(131547664918868.0d0*exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5)) + &
      10897548193740.5d0)
   drdy(6, 4) = 2.86709403645478d+27*y(4)*exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5))/(131547664918868.0d0*exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5)) + &
      10897548193740.5d0)
   drdy(6, 5) = -44834678171163.1d0*y(2)*y(5)*exp(-32.231614828059186d0*y(1) - &
      99.327521577403942d0*y(5))*exp(16.115807414029593d0*y(1) + &
      49.663760788701971d0*y(5))/(exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5)) + 0.0828410614545045d0)**2 - &
      1.18756556634897d+26*y(2)*exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5))*exp(16.115807414029593d0*y(1) + &
      49.663760788701971d0*y(5))/(131547664918868.0d0*exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5)) + &
      10897548193740.5d0) - 7.1195336192602d+28*y(4)**2*exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5))/( &
      131547664918868.0d0*exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5)) + 10897548193740.5d0) + &
      541213226677279.0d0*y(4)**2*exp(-32.231614828059186d0*y(1) - &
      99.327521577403942d0*y(5))/(exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5)) + 0.0828410614545045d0)**2
   drdy(7, 1) = 3763656.13241337d0*y(1)*y(5)*exp(18.205389780854059d0*y(1) + &
      12.74881008180205d0*y(6) + 1.5935386012636996d0*y(3) + &
      0.7075812481389504d0*y(2) + 22.69271305309038d0*y(5) + &
      1.7640148692260327d0*y(4)) + 206733.070685005d0*y(5)*exp( &
      18.205389780854059d0*y(1) + 12.74881008180205d0*y(6) + &
      1.5935386012636996d0*y(3) + 0.7075812481389504d0*y(2) + &
      22.69271305309038d0*y(5) + 1.7640148692260327d0*y(4))
   drdy(7, 2) = 146280.444186894d0*y(1)*y(5)*exp(18.205389780854059d0*y(1) + &
      12.74881008180205d0*y(6) + 1.5935386012636996d0*y(3) + &
      0.7075812481389504d0*y(2) + 22.69271305309038d0*y(5) + &
      1.7640148692260327d0*y(4))
   drdy(7, 3) = 329437.128294333d0*y(1)*y(5)*exp(18.205389780854059d0*y(1) + &
      12.74881008180205d0*y(6) + 1.5935386012636996d0*y(3) + &
      0.7075812481389504d0*y(2) + 22.69271305309038d0*y(5) + &
      1.7640148692260327d0*y(4))
   drdy(7, 4) = 364680.210649106d0*y(1)*y(5)*exp(18.205389780854059d0*y(1) + &
      12.74881008180205d0*y(6) + 1.5935386012636996d0*y(3) + &
      0.7075812481389504d0*y(2) + 22.69271305309038d0*y(5) + &
      1.7640148692260327d0*y(4))
   drdy(7, 5) = 4691334.25163907d0*y(1)*y(5)*exp(18.205389780854059d0*y(1) + &
      12.74881008180205d0*y(6) + 1.5935386012636996d0*y(3) + &
      0.7075812481389504d0*y(2) + 22.69271305309038d0*y(5) + &
      1.7640148692260327d0*y(4)) + 206733.070685005d0*y(1)*exp( &
      18.205389780854059d0*y(1) + 12.74881008180205d0*y(6) + &
      1.5935386012636996d0*y(3) + 0.7075812481389504d0*y(2) + &
      22.69271305309038d0*y(5) + 1.7640148692260327d0*y(4))
   drdy(7, 6) = 2635600.65579089d0*y(1)*y(5)*exp(18.205389780854059d0*y(1) + &
      12.74881008180205d0*y(6) + 1.5935386012636996d0*y(3) + &
      0.7075812481389504d0*y(2) + 22.69271305309038d0*y(5) + &
      1.7640148692260327d0*y(4))
   drdy(8, 1) = 908117027.368141d0*y(1)*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4)) + 2636566.44783849d0*y(6)*vac(1)*exp( &
      0.98133471438951925d0*y(1) - 26.703923717870133d0*y(6) - &
      3.3378592179649362d0*y(3) - 1.4821144525063803d0*y(2) - &
      16.105742820852516d0*y(5) - 3.6949423673854072d0*y(4)) - &
      1594687727.38097d0*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4))
   drdy(8, 2) = -1371533434.10128d0*y(1)*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4)) - 3982018.75469756d0*y(6)*vac(1)*exp( &
      0.98133471438951925d0*y(1) - 26.703923717870133d0*y(6) - &
      3.3378592179649362d0*y(3) - 1.4821144525063803d0*y(2) - &
      16.105742820852516d0*y(5) - 3.6949423673854072d0*y(4))
   drdy(8, 3) = -3088820507.76867d0*y(1)*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4)) - 8967875.58072834d0*y(6)*vac(1)*exp( &
      0.98133471438951925d0*y(1) - 26.703923717870133d0*y(6) - &
      3.3378592179649362d0*y(3) - 1.4821144525063803d0*y(2) - &
      16.105742820852516d0*y(5) - 3.6949423673854072d0*y(4))
   drdy(8, 4) = -3419261572.79989d0*y(1)*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4)) - 1594687727.38097d0*y(1)*exp( &
      -1.5507985735361509d0*y(1) + 42.200083419298494d0*y(6) + &
      5.2748030187688606d0*y(3) + 2.3421784076945262d0*y(2) + &
      25.451828643253517d0*y(5) + 5.839099818459224d0*y(4))*exp( &
      0.98133471438951925d0*y(1) - 26.703923717870133d0*y(6) - &
      3.3378592179649362d0*y(3) - 1.4821144525063803d0*y(2) - &
      16.105742820852516d0*y(5) - 3.6949423673854072d0*y(4)) - &
      9927256.14379768d0*y(6)*vac(1)*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4))
   drdy(8, 5) = -14904088360.0322d0*y(1)*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4)) - 43271536.7308614d0*y(6)*vac(1)*exp( &
      0.98133471438951925d0*y(1) - 26.703923717870133d0*y(6) - &
      3.3378592179649362d0*y(3) - 1.4821144525063803d0*y(2) - &
      16.105742820852516d0*y(5) - 3.6949423673854072d0*y(4))
   drdy(8, 6) = -24711535697.4034d0*y(1)*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4)) - 71745825.6268601d0*y(6)*vac(1)*exp( &
      0.98133471438951925d0*y(1) - 26.703923717870133d0*y(6) - &
      3.3378592179649362d0*y(3) - 1.4821144525063803d0*y(2) - &
      16.105742820852516d0*y(5) - 3.6949423673854072d0*y(4)) + &
      2686714.74592508d0*vac(1)*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4))
   drdy(9, 1) = 812365556.484036d0*y(6)*vac(1)*exp(14.358332074823355d0*y(1))
   drdy(9, 6) = 56577989.1599303d0*vac(1)*exp(14.358332074823355d0*y(1))
   drdy(10, 5) = 10897548193740.5d0*y(6)
   drdy(10, 6) = 10897548193740.5d0*y(5)
   drdy(11, 4) = 10897548193740.5d0*y(6)
   drdy(11, 6) = 10897548193740.5d0*y(4)

   drdvac = 0
   drdvac(1, 1) = 22338970.6897763d0
   drdvac(2, 1) = 37616785.5613267d0
   drdvac(4, 1) = 261693.859319608d0*y(2)*exp(-6.7955200184597802d0*y(1))
   drdvac(5, 1) = 63.869994514691d0*y(4)*exp(-15.408208399833654d0*y(1) - 30.747507666161923d0 &
      *y(5))
   drdvac(8, 1) = 2686714.74592508d0*y(6)*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4))
   drdvac(9, 1) = 56577989.1599303d0*y(6)*exp(14.358332074823355d0*y(1))

   drdy = drdy + matmul(drdvac, dvacdy)

   jac = matmul(dypdr, drdy) - cj * mas

end subroutine fidadjac

subroutine ratecalc(neqin, yin)

   use solve_ida, only: rates

   implicit none

   integer, intent(in) :: neqin
   real*8, intent(in) :: yin(neqin)
   real*8 :: y(neqin)
   real*8 :: vac(1)

   integer :: i

   y = yin


   vac = 0
   vac(1) = -y(1) - y(6) - y(3) - y(2) - y(5) - y(4) + 1

   do i = 1, 1
      if (vac(i) < -1d-10) then
         vac(i) = 0.d0
      endif
   enddo

   rates = 0
   rates(1) = -2.30717032382649d0*y(1)*exp(34.810185027303113d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4)) + 22338970.6897763d0*vac(1)
   rates(2) = -253618883509.056d0*y(2)*exp(2.3421784076945262d0*y(1)) + &
      37616785.5613267d0*vac(1)
   rates(3) = -153176457.308992d0*y(3)**2*exp(10.549606037537721d0*y(1))
   rates(4) = -66296806009.741d0*y(3)*y(4)*exp(1.9762044110737795d0*y(1)) + &
      261693.859319608d0*y(2)*vac(1)*exp(-6.7955200184597802d0*y(1))
   rates(5) = -1340422.18664063d0*y(3)*y(5)*exp(-15.408208399833654d0*y(1) - &
      30.747507666161923d0*y(5))*exp(24.887531843563153d0*y(1) + &
      49.663760788701971d0*y(5)) + 63.869994514691d0*y(4)*vac(1)*exp( &
      -15.408208399833654d0*y(1) - 30.747507666161923d0*y(5))
   rates(6) = -1.18756556634897d+26*y(2)*y(5)*exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5))*exp(16.115807414029593d0*y(1) + &
      49.663760788701971d0*y(5))/(131547664918868.0d0*exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5)) + &
      10897548193740.5d0) + 1.43354701822739d+27*y(4)**2*exp( &
      -16.115807414029593d0*y(1) - 49.663760788701971d0*y(5))/( &
      131547664918868.0d0*exp(-16.115807414029593d0*y(1) - &
      49.663760788701971d0*y(5)) + 10897548193740.5d0)
   rates(7) = 206733.070685005d0*y(1)*y(5)*exp(18.205389780854059d0*y(1) + &
      12.74881008180205d0*y(6) + 1.5935386012636996d0*y(3) + &
      0.7075812481389504d0*y(2) + 22.69271305309038d0*y(5) + &
      1.7640148692260327d0*y(4))
   rates(8) = -1594687727.38097d0*y(1)*y(4)*exp(-1.5507985735361509d0*y(1) + &
      42.200083419298494d0*y(6) + 5.2748030187688606d0*y(3) + &
      2.3421784076945262d0*y(2) + 25.451828643253517d0*y(5) + &
      5.839099818459224d0*y(4))*exp(0.98133471438951925d0*y(1) - &
      26.703923717870133d0*y(6) - 3.3378592179649362d0*y(3) - &
      1.4821144525063803d0*y(2) - 16.105742820852516d0*y(5) - &
      3.6949423673854072d0*y(4)) + 2686714.74592508d0*y(6)*vac(1)*exp( &
      0.98133471438951925d0*y(1) - 26.703923717870133d0*y(6) - &
      3.3378592179649362d0*y(3) - 1.4821144525063803d0*y(2) - &
      16.105742820852516d0*y(5) - 3.6949423673854072d0*y(4))
   rates(9) = 56577989.1599303d0*y(6)*vac(1)*exp(14.358332074823355d0*y(1))
   rates(10) = 10897548193740.5d0*y(6)*y(5)
   rates(11) = 10897548193740.5d0*y(6)*y(4)

end subroutine ratecalc

subroutine fidajtimes(tres, yin, ypin, res, vin, fjv, cj, ewt, h, ipar, rpar, wk1, wk2, ier)

   use solve_ida, only: neq

   implicit none

   real*8, intent(in) :: tres, yin(neq), ypin(neq), res(neq), vin(neq), cj, h
   real*8 :: ewt(*), wk1(*), wk2(*), rpar(*), wk3(1)
   integer :: ipar(*)
   integer :: i

   real*8, intent(out) :: fjv(neq)
   integer, intent(out) :: ier

   real*8 :: jac(neq, neq)

   call fidadjac(neq, tres, yin, ypin, res, jac, cj, ewt, h, ipar, rpar, wk1, wk2, wk2, ier)

   fjv = 0.d0

   call dgemv('N', neq, neq, 1.d0, jac, neq, vin, 1, 0.d0, fjv, 1)

end subroutine fidajtimes

subroutine fidapsol(tres, yin, ypin, res, rvin, zv, cj, delta, ewt, ipar, rpar, wk1, ier)

   use solve_ida, only: neq, jac

   implicit none

   real*8, intent(in) :: tres, yin(neq), ypin(neq), res(neq), rvin(neq)
   real*8, intent(in) :: cj, delta, ewt(*), rpar(*)
   integer, intent(in) :: ipar(*)

   real*8 :: wk1(*)
   integer :: ier

   real*8, intent(out) :: zv(neq)

   integer :: ipiv(neq)
   integer :: i

   zv = rvin
   call dgesv(neq, 1, jac, neq, ipiv, zv, neq, ier)

end subroutine fidapsol

subroutine fidapset(tres, yin, ypin, res, cj, ewt, h, ipar, rpar, wk1, wk2, wk3, ier)

   use solve_ida, only: neq, jac

   implicit none

   real*8, intent(in) :: tres, yin(neq), ypin(neq), res(neq)
   real*8, intent(in) :: cj, ewt(*), h, rpar(*)
   real*8 :: wk1(*), wk2(*), wk3(*)

   integer, intent(in) :: ipar(*)

   integer, intent(out) :: ier

   call fidadjac(neq, tres, yin, ypin, res, jac, cj, ewt, h, ipar, rpar, wk1, wk2, wk3, ier)

end subroutine fidapset

   